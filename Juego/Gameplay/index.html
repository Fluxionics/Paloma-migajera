<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Paloma Migajera - Capas Corregidas</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
        canvas { display: block; image-rendering: pixelated; width: 100vw; height: 100vh; }
        #mapa-ui { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; 
        }
    </style>
</head>
<body>

    <div id="mapa-ui"><img src="mapa.jpg"></div>
    <canvas id="gameCanvas"></canvas>
    <canvas id="collisionCanvas" style="display:none;"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const cCanvas = document.getElementById('collisionCanvas');
        const cCtx = cCanvas.getContext('2d');

        const assets = {
            fondo: new Image(),    // La imagen de atrás (paisaje)
            visual: new Image(),   // El suelo con color
            colision: new Image(), // La imagen blanco y negro
            pJPG: new Image(),
            pCaminando: new Image(),
            pDescanso: new Image(),
            pMirando: new Image()
        };

        Object.values(assets).forEach(img => img.crossOrigin = "anonymous");

        // ASIGNACIÓN DE ARCHIVOS
        assets.fondo.src = 'fondo.jpg';
        assets.visual.src = 'terreno_visual.jpg';
        assets.colision.src = 'terreno_colision.jpg'; 
        assets.pJPG.src = 'paloma.jpg';
        assets.pCaminando.src = 'Caminando.gif';
        assets.pDescanso.src = 'Descanso.gif';
        assets.pMirando.src = 'Visualisando_Mapa.gif';

        const p = { 
            x: 150, y: 50, w: 90, h: 90, 
            vx: 0, vy: 0, dir: 1, 
            movido: false, mirando: false, sprite: null 
        };
        const cam = { x: 0 };
        const keys = {};

        window.onkeydown = (e) => { keys[e.code] = true; if(e.code === 'KeyM') p.mirando = !p.mirando; };
        window.onkeyup = (e) => keys[e.code] = false;

        function esSuelo(x, y) {
            if (x < 0 || x >= cCanvas.width || y < 0 || y >= cCanvas.height) return false;
            // Lee la imagen terreno_colision.jpg
            const pixel = cCtx.getImageData(Math.floor(x), Math.floor(y), 1, 1).data;
            // Detecta si el píxel es negro (R < 100)
            return (pixel[0] < 100 && pixel[3] > 0);
        }

        function update() {
            if (p.mirando) {
                p.sprite = assets.pMirando;
                document.getElementById('mapa-ui').style.display = 'flex';
                p.vx = 0;
            } else {
                document.getElementById('mapa-ui').style.display = 'none';
                p.vy += 0.8;

                if (keys['ArrowRight'] || keys['KeyD']) {
                    p.vx = 6; p.dir = 1; p.movido = true;
                    p.sprite = assets.pCaminando;
                } else if (keys['ArrowLeft'] || keys['KeyA']) {
                    p.vx = -6; p.dir = -1; p.movido = true;
                    p.sprite = assets.pCaminando;
                } else {
                    p.vx = 0;
                    p.sprite = p.movido ? assets.pDescanso : assets.pJPG;
                }

                // Colisión lateral
                if (!esSuelo(p.x + (p.dir === 1 ? p.w : 0) + p.vx, p.y + p.h - 20)) {
                    p.x += p.vx;
                }

                p.y += p.vy;

                // Colisión de suelo (revisa toda la base)
                let toca = false;
                for(let i=0; i<=p.w; i+=p.w/2) {
                    if(esSuelo(p.x + i, p.y + p.h)) { toca = true; break; }
                }

                if (toca) {
                    p.vy = 0;
                    while (esSuelo(p.x + p.w/2, p.y + p.h - 1)) p.y--;
                    if (keys['Space'] || keys['KeyW']) p.vy = -16;
                }
            }
            cam.x = p.x - canvas.width / 2;
            if (cam.x < 0) cam.x = 0;
        }

        function draw() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 1. DIBUJAR FONDO (Estático o con poco movimiento)
            ctx.drawImage(assets.fondo, 0, 0, canvas.width, canvas.height);

            ctx.save();
            ctx.translate(-cam.x, 0);

            // 2. DIBUJAR TERRENO VISUAL (El que camina)
            ctx.drawImage(assets.visual, 0, 0);

            // 3. DIBUJAR PALOMA
            ctx.save();
            let img = p.sprite || assets.pJPG;
            if (p.dir === -1) {
                ctx.translate(p.x + p.w, p.y);
                ctx.scale(-1, 1);
                ctx.drawImage(img, 0, 0, p.w, p.h);
            } else {
                ctx.drawImage(img, p.x, p.y, p.w, p.h);
            }
            ctx.restore();
            ctx.restore();
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        let cargados = 0;
        Object.values(assets).forEach(img => {
            img.onload = () => {
                cargados++;
                if (cargados === Object.keys(assets).length) {
                    cCanvas.width = assets.visual.width;
                    cCanvas.height = assets.visual.height;
                    cCtx.drawImage(assets.colision, 0, 0);
                    loop();
                }
            };
        });
    </script>
</body>
</html>
</html>

