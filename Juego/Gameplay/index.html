<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Paloma Migajera - Full Game</title>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
        canvas { 
            display: block; 
            image-rendering: pixelated; 
            width: 100vw; 
            height: 100vh; 
        }
        #mapa-ui { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; 
        }
        #mapa-ui img { max-width: 90%; max-height: 90%; border: 3px solid white; }
    </style>
</head>
<body>

    <div id="mapa-ui"><img src="mapa.jpg"></div>
    <canvas id="gameCanvas"></canvas>
    <canvas id="collisionCanvas" style="display:none;"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const cCanvas = document.getElementById('collisionCanvas');
        const cCtx = cCanvas.getContext('2d');

        const assets = {
            visual: new Image(),
            colision: new Image(),
            pJPG: new Image(),
            pCaminando: new Image(),
            pDescanso: new Image(),
            pMirando: new Image()
        };

        // Evitar errores de seguridad al leer píxeles
        Object.values(assets).forEach(img => img.crossOrigin = "anonymous");

        // CARGA DE ARCHIVOS
        assets.visual.src = 'terreno_visual.jpg';
        assets.colision.src = 'terreno_colision.jpg'; 
        assets.pJPG.src = 'paloma.jpg';
        assets.pCaminando.src = 'Caminando.gif';
        assets.pDescanso.src = 'Descanso.gif';
        assets.pMirando.src = 'Visualisando_Mapa.gif';

        const p = { 
            x: 100, y: 0, w: 90, h: 90, 
            vx: 0, vy: 0, dir: 1, 
            movido: false, mirando: false, sprite: null 
        };
        const cam = { x: 0 };
        const keys = {};

        window.onkeydown = (e) => { 
            keys[e.code] = true; 
            if(e.code === 'KeyM') p.mirando = !p.mirando;
        };
        window.onkeyup = (e) => keys[e.code] = false;

        // FUNCIÓN DE COLISIÓN (Píxel Negro = Suelo/Pared)
        function checkPixel(x, y) {
            if (x < 0 || x >= cCanvas.width || y >= cCanvas.height || y < 0) return false;
            const data = cCtx.getImageData(Math.floor(x), Math.floor(y), 1, 1).data;
            // Detecta si es negro (R,G,B bajos) y no es transparente
            return (data[0] < 50 && data[1] < 50 && data[2] < 50 && data[3] > 0);
        }

        function update() {
            if (p.mirando) {
                p.sprite = assets.pMirando;
                document.getElementById('mapa-ui').style.display = 'flex';
                p.vx = 0;
            } else {
                document.getElementById('mapa-ui').style.display = 'none';
                p.vy += 0.8; // Gravedad

                // Movimiento
                if (keys['ArrowRight'] || keys['KeyD']) {
                    p.vx = 6; p.dir = 1; p.movido = true;
                    p.sprite = assets.pCaminando;
                } else if (keys['ArrowLeft'] || keys['KeyA']) {
                    p.vx = -6; p.dir = -1; p.movido = true;
                    p.sprite = assets.pCaminando;
                } else {
                    p.vx = 0;
                    p.sprite = p.movido ? assets.pDescanso : assets.pJPG;
                }

                // Colisión Lateral
                let frontX = p.x + (p.dir === 1 ? p.w : 0) + p.vx;
                if (!checkPixel(frontX, p.y + p.h / 2)) {
                    p.x += p.vx;
                }

                p.y += p.vy;

                // Colisión de Suelo
                // Revisamos tres puntos abajo (izquierda, centro, derecha) para que no se caiga
                let pieIzquierda = checkPixel(p.x + 10, p.y + p.h);
                let pieCentro = checkPixel(p.x + p.w / 2, p.y + p.h);
                let pieDerecha = checkPixel(p.x + p.w - 10, p.y + p.h);

                if (pieIzquierda || pieCentro || pieDerecha) {
                    p.vy = 0;
                    // Ajuste para que no se hunda
                    while (checkPixel(p.x + p.w / 2, p.y + p.h - 1)) {
                        p.y--;
                    }
                    if (keys['Space'] || keys['KeyW'] || keys['ArrowUp']) {
                        p.vy = -16; // Fuerza de salto
                    }
                }
            }
            // Cámara sigue a la paloma
            cam.x = p.x - canvas.width / 2;
            if (cam.x < 0) cam.x = 0;
        }

        function draw() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            ctx.save();
            ctx.translate(-cam.x, 0);

            // 1. DIBUJAR TERRENO VISUAL
            ctx.drawImage(assets.visual, 0, 0);

            // 2. DIBUJAR PALOMA
            ctx.save();
            let imgToDraw = p.sprite || assets.pJPG;
            if (p.dir === -1) {
                ctx.translate(p.x + p.w, p.y);
                ctx.scale(-1, 1);
                ctx.drawImage(imgToDraw, 0, 0, p.w, p.h);
            } else {
                ctx.drawImage(imgToDraw, p.x, p.y, p.w, p.h);
            }
            ctx.restore();
            ctx.restore();
        }

        function loop() {
            update();
            draw();
            requestAnimationFrame(loop);
        }

        // ESPERAR A QUE TODAS LAS IMÁGENES CARGUEN
        let cargados = 0;
        const total = Object.keys(assets).length;
        Object.values(assets).forEach(img => {
            img.onload = () => {
                cargados++;
                if (cargados === total) {
                    // El canvas de colisión debe ser del tamaño de la imagen original
                    cCanvas.width = assets.visual.width;
                    cCanvas.height = assets.visual.height;
                    cCtx.drawImage(assets.colision, 0, 0);
                    loop();
                }
            };
        });
    </script>
</body>
</html>
