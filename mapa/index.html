<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Mapa ‚Äî Paloma Migajera</title>
  <link rel="stylesheet" href="../shared/global.css">
  <style>
    body { overflow:hidden; }

    .map-layout {
      width:100%; height:100%;
      display:grid;
      grid-template-rows: auto 1fr auto;
      grid-template-columns: 1fr 280px;
      gap:0;
    }

    /* ---- Header ---- */
    .map-header {
      grid-column:1/-1;
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 20px;
      background:rgba(10,10,16,.95);
      border-bottom:1px solid var(--border);
    }
    .map-header-title {
      font-family:var(--font-title); font-size:.9rem; font-weight:900;
      letter-spacing:.2em; color:var(--white);
    }
    .map-header-sub { font-style:italic; font-size:.8rem; color:var(--text-dim); margin-left:12px; }

    /* ---- Canvas del mapa ---- */
    .map-canvas-wrap {
      position:relative; overflow:hidden;
      background:var(--ink);
      border-right:1px solid var(--border);
    }
    #world-canvas { display:block; width:100%; height:100%; image-rendering:pixelated; }

    /* ---- Panel de info ---- */
    .map-info {
      display:flex; flex-direction:column;
      background:rgba(10,10,16,.9);
      overflow-y:auto;
      padding:0;
    }

    .info-block {
      padding:18px 18px;
      border-bottom:1px solid var(--border);
    }
    .info-block-title {
      font-family:var(--font-title); font-size:.58rem; letter-spacing:.25em;
      color:var(--gold); text-transform:uppercase; margin-bottom:12px;
    }

    /* Zona seleccionada */
    .zone-name { font-family:var(--font-title); font-size:.9rem; letter-spacing:.1em; color:var(--white); margin-bottom:4px; }
    .zone-status {
      font-family:var(--font-title); font-size:.55rem; letter-spacing:.2em; text-transform:uppercase;
      padding:3px 10px; border:1px solid; display:inline-block; margin-bottom:10px;
    }
    .zone-status.current  { color:var(--gold);  border-color:var(--gold-dim); background:rgba(232,200,64,.08); }
    .zone-status.visited  { color:var(--green); border-color:#308050; background:rgba(64,184,96,.06); }
    .zone-status.locked   { color:var(--muted); border-color:var(--muted); }
    .zone-desc { font-style:italic; font-size:.85rem; color:var(--text-dim); line-height:1.6; margin-bottom:12px; }

    .zone-stat-row {
      display:flex; justify-content:space-between; align-items:center;
      padding:4px 0; border-bottom:1px solid rgba(255,255,255,.04);
      font-size:.82rem;
    }
    .zone-stat-row:last-child { border:none; }
    .zsl { color:var(--text-dim); }
    .zsv { color:var(--text-hi); font-family:var(--font-title); font-size:.7rem; letter-spacing:.06em; }

    /* Leyenda */
    .legend-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
    .leg-item { display:flex; align-items:center; gap:6px; font-size:.78rem; color:var(--text-dim); }
    .leg-dot  { width:10px; height:10px; border-radius:50%; flex-shrink:0; }

    /* Stats globales */
    .global-stats { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .gs-card { padding:10px 12px; background:rgba(255,255,255,.025); border:1px solid var(--border); text-align:center; }
    .gs-val { font-family:var(--font-title); font-size:1rem; color:var(--gold); display:block; }
    .gs-lbl { font-size:.72rem; color:var(--text-dim); }

    /* ---- Footer ---- */
    .map-footer {
      grid-column:1/-1;
      display:flex; align-items:center; gap:10px;
      padding:10px 18px;
      background:rgba(10,10,16,.95);
      border-top:1px solid var(--border);
    }
    .map-hint { font-family:var(--font-title); font-size:.55rem; letter-spacing:.15em; color:var(--muted); }
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="grain"></div>

  <div class="screen map-layout">

    <!-- Header -->
    <div class="map-header">
      <div>
        <span class="map-header-title">üó∫Ô∏è MAPA DEL MUNDO</span>
        <span class="map-header-sub" id="hdr-sub">Ciudad urbana nocturna</span>
      </div>
      <button class="btn btn-ghost" onclick="goBack()">‚Üê Volver</button>
    </div>

    <!-- Canvas del mapa -->
    <div class="map-canvas-wrap">
      <canvas id="world-canvas"></canvas>
    </div>

    <!-- Panel de info derecha -->
    <aside class="map-info">

      <div class="info-block">
        <div class="info-block-title">Zona Seleccionada</div>
        <div class="zone-name" id="z-name">Ciudad Alta</div>
        <div class="zone-status current" id="z-status">Ubicaci√≥n actual</div>
        <div class="zone-desc" id="z-desc">Los tejados y cornisas m√°s altas de la ciudad. Farolas, gatos y migajas doradas.</div>
        <div class="zone-stat-row"><span class="zsl">Enemigos</span><span class="zsv" id="z-enemies">Gatos, Ratas, Cuervo</span></div>
        <div class="zone-stat-row"><span class="zsl">Jefe</span><span class="zsv" id="z-boss">Cuervo Chimenea</span></div>
        <div class="zone-stat-row"><span class="zsl">Recompensa</span><span class="zsv" id="z-reward">Doble Salto</span></div>
        <div class="zone-stat-row"><span class="zsl">Estado</span><span class="zsv" id="z-prog">En progreso</span></div>
      </div>

      <div class="info-block">
        <div class="info-block-title">Leyenda</div>
        <div class="legend-grid">
          <div class="leg-item"><div class="leg-dot" style="background:#e8c840"></div>Checkpoint</div>
          <div class="leg-item"><div class="leg-dot" style="background:#c03030"></div>Jefe</div>
          <div class="leg-item"><div class="leg-dot" style="background:#6ab0d8"></div>Portal</div>
          <div class="leg-item"><div class="leg-dot" style="background:#40b860"></div>NPC</div>
          <div class="leg-item"><div class="leg-dot" style="background:#ffffff"></div>Jugadora</div>
          <div class="leg-item"><div class="leg-dot" style="background:#606080"></div>Enemigo</div>
        </div>
      </div>

      <div class="info-block">
        <div class="info-block-title">Progreso Global</div>
        <div class="global-stats" id="global-stats"></div>
      </div>

    </aside>

    <!-- Footer -->
    <div class="map-footer">
      <span class="map-hint">Haz clic en una zona para ver sus detalles</span>
      <span style="margin-left:auto">
        <button class="btn btn-primary" onclick="goToGame()" style="font-size:.6rem;padding:8px 18px;">‚ñ∂ Ir al juego</button>
      </span>
    </div>

  </div>

  <script src="../shared/utils.js"></script>
  <script>
    const canvas = document.getElementById('world-canvas');
    const ctx    = canvas.getContext('2d');
    const save   = getSave() || defaultSave();

    // ---- Definici√≥n visual de zonas en el mapa del mundo ----
    const WORLD_ZONES = [
      {
        id:'ciudad_alta',
        name:'Ciudad Alta',
        desc:'Los tejados y cornisas m√°s altas. Farolas, gatos y migajas doradas entre la niebla nocturna.',
        enemies:'Gatos, Ratas, Cuervo',
        boss:'Cuervo de la Chimenea',
        reward:'Doble Salto',
        // Posici√≥n en el mapa del mundo (0-1 relativo)
        rx:0.15, ry:0.2, rw:0.35, rh:0.55,
        color:'#1a1a2a', borderColor:'#303050',
        icon:'üèôÔ∏è',
      },
      {
        id:'alcantarillas',
        name:'Alcantarillas de Migas',
        desc:'Las profundidades h√∫medas bajo la ciudad. Tuber√≠as oxidadas y ratas enormes custodian sus secretos.',
        enemies:'Ratas, Gatos Alcantarilla',
        boss:'Rata Reina',
        reward:'Picado Bal√≠stico',
        rx:0.52, ry:0.35, rw:0.28, rh:0.45,
        color:'#0e180e', borderColor:'#204020',
        icon:'üèöÔ∏è',
      },
      {
        id:'tejado_gansos',
        name:'Tejado de los Gansos',
        desc:'Zona de acceso a√∫n no descubierta. Los gansos guardan las migajas m√°s grandes de la ciudad.',
        enemies:'???',
        boss:'???',
        reward:'Planeo Silencioso',
        rx:0.55, ry:0.08, rw:0.25, rh:0.25,
        color:'#0a0a0a', borderColor:'#202020',
        icon:'üîí',
        locked:true,
      },
      {
        id:'nido_halcon',
        name:'Nido del Halc√≥n',
        desc:'En las alturas extremas de la antena m√°s alta. Solo accesible con habilidades avanzadas.',
        enemies:'???',
        boss:'Halc√≥n Guardi√°n',
        reward:'Dash de Aire',
        rx:0.82, ry:0.05, rw:0.15, rh:0.28,
        color:'#0a0a0a', borderColor:'#202020',
        icon:'üîí',
        locked:true,
      },
    ];

    // ---- Estado ----
    let selectedZone = WORLD_ZONES[0];
    let animT = 0;
    let playerDot = { x:0, y:0, pulse:0 };

    function resize() {
      const wrap = canvas.parentElement;
      canvas.width  = wrap.clientWidth;
      canvas.height = wrap.clientHeight;
    }
    resize();
    window.addEventListener('resize', ()=>{ resize(); drawMap(); });

    // ---- Dibujo del mapa ----
    function drawMap() {
      const W = canvas.width, H = canvas.height;
      const t = animT / 1000;

      // Fondo
      ctx.fillStyle = '#08080f';
      ctx.fillRect(0,0,W,H);

      // Cuadr√≠cula sutil
      ctx.strokeStyle = 'rgba(255,255,255,0.02)';
      ctx.lineWidth = 1;
      const gridStep = 40;
      for(let x=0;x<W;x+=gridStep){ ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke(); }
      for(let y=0;y<H;y+=gridStep){ ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke(); }

      // Conexiones entre zonas
      drawConnections(W,H,t);

      // Zonas
      WORLD_ZONES.forEach(z => drawZoneBlock(z, W, H, t));

      // Punto del jugador
      drawPlayerDot(W,H,t);

      animT += 16;
      requestAnimationFrame(drawMap);
    }

    function drawConnections(W,H,t) {
      const connections = [
        ['ciudad_alta','alcantarillas'],
        ['ciudad_alta','tejado_gansos'],
        ['tejado_gansos','nido_halcon'],
      ];
      connections.forEach(([a,b]) => {
        const za = WORLD_ZONES.find(z=>z.id===a);
        const zb = WORLD_ZONES.find(z=>z.id===b);
        if(!za||!zb) return;
        const x1 = (za.rx+za.rw/2)*W;
        const y1 = (za.ry+za.rh/2)*H;
        const x2 = (zb.rx+zb.rw/2)*W;
        const y2 = (zb.ry+zb.rh/2)*H;
        const visited = save.zonasVisitadas?.includes(b);
        ctx.save();
        ctx.setLineDash([6,6]);
        ctx.lineDashOffset = -t*10;
        ctx.strokeStyle = visited ? 'rgba(232,200,64,0.3)' : 'rgba(80,80,100,0.3)';
        ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
        ctx.restore();
      });
    }

    function drawZoneBlock(z, W, H, t) {
      const x = z.rx*W, y = z.ry*H, w = z.rw*W, h = z.rh*H;
      const isCurrent  = z.id === save.zona;
      const isVisited  = save.zonasVisitadas?.includes(z.id);
      const isSelected = z.id === selectedZone?.id;
      const isLocked   = z.locked;

      // Fondo de zona
      ctx.fillStyle = isLocked ? '#0a0a0a' : z.color;
      ctx.fillRect(x,y,w,h);

      // Borde
      ctx.strokeStyle = isSelected
        ? 'rgba(232,200,64,0.8)'
        : isCurrent ? 'rgba(232,200,64,0.5)'
        : isVisited ? 'rgba(64,184,96,0.4)'
        : z.borderColor;
      ctx.lineWidth = isSelected ? 2 : 1;
      ctx.strokeRect(x,y,w,h);

      // Efecto de selecci√≥n: esquinas brillantes
      if(isSelected) {
        const cs = 10;
        ctx.strokeStyle = 'rgba(232,200,64,0.9)';
        ctx.lineWidth = 2;
        // Esquina TL
        ctx.beginPath();ctx.moveTo(x,y+cs);ctx.lineTo(x,y);ctx.lineTo(x+cs,y);ctx.stroke();
        // Esquina TR
        ctx.beginPath();ctx.moveTo(x+w-cs,y);ctx.lineTo(x+w,y);ctx.lineTo(x+w,y+cs);ctx.stroke();
        // Esquina BL
        ctx.beginPath();ctx.moveTo(x,y+h-cs);ctx.lineTo(x,y+h);ctx.lineTo(x+cs,y+h);ctx.stroke();
        // Esquina BR
        ctx.beginPath();ctx.moveTo(x+w-cs,y+h);ctx.lineTo(x+w,y+h);ctx.lineTo(x+w,y+h-cs);ctx.stroke();
      }

      // Overlay si bloqueado
      if(isLocked) {
        ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(x,y,w,h);
      }

      // Textura mini (puntos para simular edificios)
      if(!isLocked) {
        ctx.save();
        ctx.fillStyle='rgba(255,255,255,0.04)';
        for(let bx=x+8;bx<x+w-8;bx+=18) {
          const bh2 = 20+Math.sin(bx*0.1)*15;
          ctx.fillRect(bx, y+h-bh2, 10, bh2);
        }
        ctx.restore();
      }

      // √çcono
      ctx.font = '18px serif';
      ctx.textAlign = 'center';
      ctx.fillText(z.icon, x+w/2, y+22);

      // Nombre
      ctx.fillStyle = isLocked ? '#404050' : isSelected ? '#f0f0ff' : '#b0b0d0';
      ctx.font = 'bold 10px serif';
      ctx.textAlign = 'center';
      ctx.fillText(z.name.toUpperCase(), x+w/2, y+36);

      // Badge: ACTUAL / VISITADO / BLOQUEADO
      if(isCurrent) {
        ctx.fillStyle = 'rgba(232,200,64,0.85)';
        const bw2=60, bh2=14;
        ctx.fillRect(x+w/2-bw2/2, y+h-22, bw2, bh2);
        ctx.fillStyle='#000';
        ctx.font='bold 7px serif'; ctx.textAlign='center';
        ctx.fillText('AQU√ç', x+w/2, y+h-12);
      } else if(isVisited && !isLocked) {
        ctx.fillStyle='rgba(64,184,96,0.15)';
        ctx.fillRect(x,y,w,h);
      }
    }

    function drawPlayerDot(W,H,t) {
      const zone = WORLD_ZONES.find(z=>z.id===save.zona);
      if(!zone) return;
      const px = (zone.rx + zone.rw*0.5)*W;
      const py = (zone.ry + zone.rh*0.5)*H + 12;
      const pulse = Math.sin(t*3)*4;
      ctx.save();
      ctx.shadowColor='#fff'; ctx.shadowBlur=12+pulse;
      ctx.fillStyle='#fff';
      ctx.beginPath(); ctx.arc(px,py,4+pulse*0.3,0,Math.PI*2); ctx.fill();
      // Anillo parpadeante
      ctx.globalAlpha=0.4+Math.sin(t*3)*0.2;
      ctx.strokeStyle='#fff'; ctx.lineWidth=1.5;
      ctx.beginPath(); ctx.arc(px,py,10+pulse,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }

    // ---- Clic en zonas ----
    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const mx = (e.clientX - rect.left) * (canvas.width/rect.width);
      const my = (e.clientY - rect.top)  * (canvas.height/rect.height);
      const W = canvas.width, H = canvas.height;
      for(const z of WORLD_ZONES) {
        const zx=z.rx*W, zy=z.ry*H, zw=z.rw*W, zh=z.rh*H;
        if(mx>=zx&&mx<=zx+zw&&my>=zy&&my<=zy+zh) {
          selectedZone = z;
          updateInfoPanel(z);
          break;
        }
      }
    });

    function updateInfoPanel(z) {
      const isCurrent  = z.id === save.zona;
      const isVisited  = save.zonasVisitadas?.includes(z.id);
      document.getElementById('z-name').textContent = z.name;
      document.getElementById('z-desc').textContent = z.desc;
      document.getElementById('z-enemies').textContent = z.enemies;
      document.getElementById('z-boss').textContent = z.boss;
      document.getElementById('z-reward').textContent = z.reward;
      document.getElementById('z-prog').textContent = z.locked ? 'Bloqueado' : isCurrent ? 'En progreso' : isVisited ? 'Visitado' : 'Sin visitar';
      const st = document.getElementById('z-status');
      st.className = 'zone-status';
      if(z.locked)      { st.textContent='Bloqueado';      st.classList.add('locked');  }
      else if(isCurrent){ st.textContent='Ubicaci√≥n actual';st.classList.add('current'); }
      else if(isVisited){ st.textContent='Visitado';        st.classList.add('visited'); }
      else              { st.textContent='Sin visitar';     st.classList.add('locked');  }
    }

    function goBack() {
      const fromGame = document.referrer.includes('juego');
      goTo(fromGame ? '../juego/index.html' : '../menu/index.html');
    }
    function goToGame() { goTo('../juego/index.html'); }

    // ---- Init ----
    document.addEventListener('DOMContentLoaded', () => {
      updateInfoPanel(selectedZone);
      // Stats globales
      document.getElementById('global-stats').innerHTML = `
        <div class="gs-card"><span class="gs-val">${save.migajas}</span><span class="gs-lbl">Migajas</span></div>
        <div class="gs-card"><span class="gs-val">${fmtTime(save.tiempoJugado)}</span><span class="gs-lbl">Jugado</span></div>
        <div class="gs-card"><span class="gs-val">${save.muertes}</span><span class="gs-lbl">Muertes</span></div>
        <div class="gs-card"><span class="gs-val">${save.zonasVisitadas?.length||1} / ${WORLD_ZONES.length}</span><span class="gs-lbl">Zonas</span></div>
      `;
      drawMap();
    });
  </script>
</body>
</html>
